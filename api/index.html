
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://devbijay.github.io/FastAPI-Cap/api/">
      
      
        <link rel="prev" href="../strategies/gcra/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>API Reference - FastAPI Cap</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="pink">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="FastAPI Cap" class="md-header__button md-logo" aria-label="FastAPI Cap" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FastAPI Cap
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="pink"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="pink"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/devbijay/FastAPI-Cap" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    FastAPI Cap
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../quickstart/" class="md-tabs__link">
        
  
  
    
  
  Quick Start

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../strategies/overview/" class="md-tabs__link">
          
  
  
  Strategies

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  API Reference

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="FastAPI Cap" class="md-nav__button md-logo" aria-label="FastAPI Cap" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    FastAPI Cap
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/devbijay/FastAPI-Cap" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    FastAPI Cap
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Strategies
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Strategies
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../strategies/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../strategies/fixed_window/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fixed Window
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../strategies/sliding_window/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sliding Window
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../strategies/sliding_window_log/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sliding Window (Log Based)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../strategies/token_bucket/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Token Bucket
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../strategies/leaky_bucket/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Leaky Bucket
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../strategies/gcra/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GCRA Rate Limiting
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cap-class" class="md-nav__link">
    <span class="md-ellipsis">
      Cap Class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastapicap.Cap" class="md-nav__link">
    <span class="md-ellipsis">
      Cap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fastapicap.Cap--now-capredis-can-be-used-by-all-limiters" class="md-nav__link">
    <span class="md-ellipsis">
      Now Cap.redis can be used by all limiters.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastapicap.Cap.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastapicap.Cap.init_app" class="md-nav__link">
    <span class="md-ellipsis">
      init_app
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strategies-class" class="md-nav__link">
    <span class="md-ellipsis">
      Strategies Class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastapicap.RateLimiter" class="md-nav__link">
    <span class="md-ellipsis">
      RateLimiter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RateLimiter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fastapicap.RateLimiter.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastapicap.SlidingWindowRateLimiter" class="md-nav__link">
    <span class="md-ellipsis">
      SlidingWindowRateLimiter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SlidingWindowRateLimiter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fastapicap.SlidingWindowRateLimiter.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastapicap.TokenBucketRateLimiter" class="md-nav__link">
    <span class="md-ellipsis">
      TokenBucketRateLimiter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TokenBucketRateLimiter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fastapicap.TokenBucketRateLimiter.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastapicap.LeakyBucketRateLimiter" class="md-nav__link">
    <span class="md-ellipsis">
      LeakyBucketRateLimiter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LeakyBucketRateLimiter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fastapicap.LeakyBucketRateLimiter.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastapicap.GCRARateLimiter" class="md-nav__link">
    <span class="md-ellipsis">
      GCRARateLimiter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GCRARateLimiter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fastapicap.GCRARateLimiter.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastapicap.SlidingWindowLogRateLimiter" class="md-nav__link">
    <span class="md-ellipsis">
      SlidingWindowLogRateLimiter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SlidingWindowLogRateLimiter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fastapicap.SlidingWindowLogRateLimiter.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/devbijay/FastAPI-Cap/edit/main/docs/api.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/devbijay/FastAPI-Cap/raw/main/docs/api.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="api-reference">API Reference</h1>
<h2 id="cap-class">Cap Class</h2>


<div class="doc doc-object doc-class">



<h2 id="fastapicap.Cap" class="doc doc-heading">
            <code>fastapicap.Cap</code>


</h2>


    <div class="doc doc-contents first">


        <p>Singleton-style Redis connection manager for Cap.</p>
<p>This class provides a shared, async Redis connection for all rate limiter
instances. It is not meant to be instantiated; use the classmethod
<code>init_app</code> to initialize the connection.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.Cap.redis">redis</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="redis.asyncio.Redis">Redis</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The shared aioredis Redis connection instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Cap.init_app("redis://localhost:6379/0")</p>
<h3 id="fastapicap.Cap--now-capredis-can-be-used-by-all-limiters">Now Cap.redis can be used by all limiters.</h3>
</details>






              <details class="quote">
                <summary>Source code in <code>fastapicap/connection.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Cap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Singleton-style Redis connection manager for Cap.</span>

<span class="sd">    This class provides a shared, async Redis connection for all rate limiter</span>
<span class="sd">    instances. It is not meant to be instantiated; use the classmethod</span>
<span class="sd">    `init_app` to initialize the connection.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        redis: The shared aioredis Redis connection instance.</span>

<span class="sd">    Example:</span>
<span class="sd">        Cap.init_app(&quot;redis://localhost:6379/0&quot;)</span>
<span class="sd">        # Now Cap.redis can be used by all limiters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">redis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Redis</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prevent instantiation of Cap.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: Always, to enforce singleton usage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Use classmethods only; do not instantiate Cap.&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_app</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">redis_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the shared Redis connection for Cap.</span>

<span class="sd">        Args:</span>
<span class="sd">            redis_url (str): The Redis connection URL.</span>

<span class="sd">        Example:</span>
<span class="sd">            Cap.init_app(&quot;redis://localhost:6379/0&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="fastapicap.Cap.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Prevent instantiation of Cap.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Always, to enforce singleton usage.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>fastapicap/connection.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prevent instantiation of Cap.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: Always, to enforce singleton usage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Use classmethods only; do not instantiate Cap.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="fastapicap.Cap.init_app" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">init_app</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the shared Redis connection for Cap.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>redis_url</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Redis connection URL.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Cap.init_app("redis://localhost:6379/0")</p>
</details>

            <details class="quote">
              <summary>Source code in <code>fastapicap/connection.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_app</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">redis_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the shared Redis connection for Cap.</span>

<span class="sd">    Args:</span>
<span class="sd">        redis_url (str): The Redis connection URL.</span>

<span class="sd">    Example:</span>
<span class="sd">        Cap.init_app(&quot;redis://localhost:6379/0&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="strategies-class"><strong>Strategies Class</strong></h2>


<div class="doc doc-object doc-class">



<h2 id="fastapicap.RateLimiter" class="doc doc-heading">
            <code>fastapicap.RateLimiter</code>


</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="fastapicap.base_limiter.BaseLimiter">BaseLimiter</span></code></p>


        <p>Implements a Fixed Window rate limiting algorithm.</p>
<p>This limiter restricts the number of requests within a fixed time window.
When a new window starts, the counter resets to zero. All requests within
the same window consume from the same counter.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of requests allowed within the defined window.
Must be a positive integer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seconds</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of seconds defining the window size.
Can be combined with minutes, hours, or days. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>minutes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of minutes defining the window size.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hours</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of hours defining the window size.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>days</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of days defining the window size.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_func</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>], <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An asynchronous or
synchronous function to extract a unique key from the request.
Defaults to client IP and path.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>on_limit</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>, <span title="fastapi.Response">Response</span>, <span title="int">int</span>], None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An
asynchronous or synchronous function called when the rate limit is exceeded.
Defaults to raising HTTP 429.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Redis key prefix for all limiter keys.
Defaults to "cap".</p>
              </div>
            </td>
            <td>
                  <code>&#39;cap&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.RateLimiter.limit">limit</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum requests allowed per window.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.RateLimiter.window_ms">window_ms</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The calculated window size in milliseconds.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.RateLimiter.lua_script">lua_script</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Lua script used for fixed window logic in Redis.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.RateLimiter._instance_id">_instance_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A unique identifier for this limiter instance, used
to create distinct Redis keys.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the <code>limit</code> is not positive or if the calculated
<code>window_ms</code> is not positive (i.e., all time units are zero).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>fastapicap/strategy/fixed_window.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RateLimiter</span><span class="p">(</span><span class="n">BaseLimiter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements a Fixed Window rate limiting algorithm.</span>

<span class="sd">    This limiter restricts the number of requests within a fixed time window.</span>
<span class="sd">    When a new window starts, the counter resets to zero. All requests within</span>
<span class="sd">    the same window consume from the same counter.</span>

<span class="sd">    Args:</span>
<span class="sd">        limit (int): The maximum number of requests allowed within the defined window.</span>
<span class="sd">            Must be a positive integer.</span>
<span class="sd">        seconds (int): The number of seconds defining the window size.</span>
<span class="sd">            Can be combined with minutes, hours, or days. Defaults to 0.</span>
<span class="sd">        minutes (int): The number of minutes defining the window size.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        hours (int): The number of hours defining the window size.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        days (int): The number of days defining the window size.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        key_func (Optional[Callable[[Request], str]]): An asynchronous or</span>
<span class="sd">            synchronous function to extract a unique key from the request.</span>
<span class="sd">            Defaults to client IP and path.</span>
<span class="sd">        on_limit (Optional[Callable[[Request, Response, int], None]]): An</span>
<span class="sd">            asynchronous or synchronous function called when the rate limit is exceeded.</span>
<span class="sd">            Defaults to raising HTTP 429.</span>
<span class="sd">        prefix (str): Redis key prefix for all limiter keys.</span>
<span class="sd">            Defaults to &quot;cap&quot;.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        limit (int): The maximum requests allowed per window.</span>
<span class="sd">        window_ms (int): The calculated window size in milliseconds.</span>
<span class="sd">        lua_script (str): The Lua script used for fixed window logic in Redis.</span>
<span class="sd">        _instance_id (str): A unique identifier for this limiter instance, used</span>
<span class="sd">            to create distinct Redis keys.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the `limit` is not positive or if the calculated</span>
<span class="sd">            `window_ms` is not positive (i.e., all time units are zero).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">key_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cap&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">key_func</span><span class="o">=</span><span class="n">key_func</span><span class="p">,</span> <span class="n">on_limit</span><span class="o">=</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_ms</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">seconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span> <span class="o">=</span> <span class="n">FIXED_WINDOW</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fixed_window_limiter_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the rate limiting logic to the incoming request. It interacts with Redis to</span>
<span class="sd">        increment a counter within the current time window and checks if the</span>
<span class="sd">        limit has been exceeded.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (Request): The incoming FastAPI request object.</span>
<span class="sd">            response (Response): The FastAPI response object. This can be</span>
<span class="sd">                modified by the `on_limit` handler if needed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">                `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">                with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">                other exceptions or handle the response differently.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">full_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_ms</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">retry_after</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="fastapicap.RateLimiter.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Apply the rate limiting logic to the incoming request. It interacts with Redis to
increment a counter within the current time window and checks if the
limit has been exceeded.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request</code>
            </td>
            <td>
                  <code><span title="fastapi.Request">Request</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The incoming FastAPI request object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>response</code>
            </td>
            <td>
                  <code><span title="fastapi.Response">Response</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The FastAPI response object. This can be
modified by the <code>on_limit</code> handler if needed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="HTTPException">HTTPException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>By default, if the rate limit is exceeded,
<code>BaseLimiter._default_on_limit</code> will raise an <code>HTTPException</code>
with status code 429. Custom <code>on_limit</code> functions may raise
other exceptions or handle the response differently.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>fastapicap/strategy/fixed_window.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the rate limiting logic to the incoming request. It interacts with Redis to</span>
<span class="sd">    increment a counter within the current time window and checks if the</span>
<span class="sd">    limit has been exceeded.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming FastAPI request object.</span>
<span class="sd">        response (Response): The FastAPI response object. This can be</span>
<span class="sd">            modified by the `on_limit` handler if needed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">            `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">            with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">            other exceptions or handle the response differently.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">full_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_ms</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">retry_after</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="fastapicap.SlidingWindowRateLimiter" class="doc doc-heading">
            <code>fastapicap.SlidingWindowRateLimiter</code>


</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="fastapicap.base_limiter.BaseLimiter">BaseLimiter</span></code></p>


        <p>Implements an <strong>Approximated Sliding Window</strong> rate limiting algorithm.</p>
<p>This algorithm provides a more accurate and smoother rate limiting experience
than a simple Fixed Window, while being more memory-efficient than a pure
log-based sliding window. It works by maintaining counters for the current
fixed window and the immediately preceding fixed window. The effective count
for the sliding window is then calculated as a weighted sum of the requests
in the previous window and the current window, based on how much of the
previous window still "slides" into the current view.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of requests allowed within the defined
sliding window. Must be a positive integer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seconds</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of seconds defining the size of the
<em>individual fixed window segments</em> that make up the sliding window.
This value, combined with others, determines the <code>window_ms</code>.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>minutes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of minutes defining the window segment size.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hours</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of hours defining the window segment size.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>days</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of days defining the window segment size.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_func</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>], <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An asynchronous or
synchronous function to extract a unique key from the request.
Defaults to client IP and path. The function should accept
a <code>fastapi.Request</code> object and return a <code>str</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>on_limit</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>, <span title="fastapi.Response">Response</span>, <span title="int">int</span>], None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An
asynchronous or synchronous function called when the rate limit is exceeded.
Defaults to raising HTTP 429. The function should accept a
<code>fastapi.Request</code>, <code>fastapi.Response</code>, and an <code>int</code> (retry_after seconds),
and should not return a value.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Redis key prefix for all limiter keys.
Defaults to "cap".</p>
              </div>
            </td>
            <td>
                  <code>&#39;cap&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.SlidingWindowRateLimiter.limit">limit</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum requests allowed within the sliding window.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.SlidingWindowRateLimiter.window_ms">window_ms</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The calculated size of a single fixed window segment
in milliseconds (e.g., if you set <code>seconds=60</code>, this is 60000ms).
The sliding window itself covers a period equivalent to <code>window_ms</code>.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.SlidingWindowRateLimiter.lua_script">lua_script</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Lua script used for the approximated sliding
window logic in Redis.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.SlidingWindowRateLimiter._instance_id">_instance_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A unique identifier for this limiter instance, used
to create distinct Redis keys for isolation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the <code>limit</code> is not positive or if the calculated
<code>window_ms</code> is not positive (i.e., all time units are zero).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This implementation relies on a Redis Lua script to atomically manage
and count requests within the current and previous fixed window segments.
The <code>retry_after</code> value provided by the Lua script indicates the
approximate time in seconds until the next request might be allowed.</p>
</details>






              <details class="quote">
                <summary>Source code in <code>fastapicap/strategy/sliding_window.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SlidingWindowRateLimiter</span><span class="p">(</span><span class="n">BaseLimiter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements an **Approximated Sliding Window** rate limiting algorithm.</span>

<span class="sd">    This algorithm provides a more accurate and smoother rate limiting experience</span>
<span class="sd">    than a simple Fixed Window, while being more memory-efficient than a pure</span>
<span class="sd">    log-based sliding window. It works by maintaining counters for the current</span>
<span class="sd">    fixed window and the immediately preceding fixed window. The effective count</span>
<span class="sd">    for the sliding window is then calculated as a weighted sum of the requests</span>
<span class="sd">    in the previous window and the current window, based on how much of the</span>
<span class="sd">    previous window still &quot;slides&quot; into the current view.</span>

<span class="sd">    Args:</span>
<span class="sd">        limit (int): The maximum number of requests allowed within the defined</span>
<span class="sd">            sliding window. Must be a positive integer.</span>
<span class="sd">        seconds (int): The number of seconds defining the size of the</span>
<span class="sd">            *individual fixed window segments* that make up the sliding window.</span>
<span class="sd">            This value, combined with others, determines the `window_ms`.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        minutes (int): The number of minutes defining the window segment size.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        hours (int): The number of hours defining the window segment size.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        days (int): The number of days defining the window segment size.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        key_func (Optional[Callable[[Request], str]]): An asynchronous or</span>
<span class="sd">            synchronous function to extract a unique key from the request.</span>
<span class="sd">            Defaults to client IP and path. The function should accept</span>
<span class="sd">            a `fastapi.Request` object and return a `str`.</span>
<span class="sd">        on_limit (Optional[Callable[[Request, Response, int], None]]): An</span>
<span class="sd">            asynchronous or synchronous function called when the rate limit is exceeded.</span>
<span class="sd">            Defaults to raising HTTP 429. The function should accept a</span>
<span class="sd">            `fastapi.Request`, `fastapi.Response`, and an `int` (retry_after seconds),</span>
<span class="sd">            and should not return a value.</span>
<span class="sd">        prefix (str): Redis key prefix for all limiter keys.</span>
<span class="sd">            Defaults to &quot;cap&quot;.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        limit (int): The maximum requests allowed within the sliding window.</span>
<span class="sd">        window_ms (int): The calculated size of a single fixed window segment</span>
<span class="sd">            in milliseconds (e.g., if you set `seconds=60`, this is 60000ms).</span>
<span class="sd">            The sliding window itself covers a period equivalent to `window_ms`.</span>
<span class="sd">        lua_script (str): The Lua script used for the approximated sliding</span>
<span class="sd">            window logic in Redis.</span>
<span class="sd">        _instance_id (str): A unique identifier for this limiter instance, used</span>
<span class="sd">            to create distinct Redis keys for isolation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the `limit` is not positive or if the calculated</span>
<span class="sd">            `window_ms` is not positive (i.e., all time units are zero).</span>

<span class="sd">    Note:</span>
<span class="sd">        This implementation relies on a Redis Lua script to atomically manage</span>
<span class="sd">        and count requests within the current and previous fixed window segments.</span>
<span class="sd">        The `retry_after` value provided by the Lua script indicates the</span>
<span class="sd">        approximate time in seconds until the next request might be allowed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">key_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cap&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">key_func</span><span class="o">=</span><span class="n">key_func</span><span class="p">,</span> <span class="n">on_limit</span><span class="o">=</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Limit must be a positive integer.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_ms</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">seconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span> <span class="o">=</span> <span class="n">SLIDING_WINDOW</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sliding_window_limiter_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies the approximated sliding window rate limiting logic to the incoming request.</span>

<span class="sd">        This method is the core of the rate limiter. It interacts with Redis to</span>
<span class="sd">        increment counters for the current and previous window segments and</span>
<span class="sd">        checks if the estimated count within the sliding window exceeds the limit.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (Request): The incoming FastAPI request object.</span>
<span class="sd">            response (Response): The FastAPI response object. This can be</span>
<span class="sd">                modified by the `on_limit` handler if needed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">                `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">                with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">                other exceptions or handle the response differently.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">now_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">curr_window_start</span> <span class="o">=</span> <span class="n">now_ms</span> <span class="o">-</span> <span class="p">(</span><span class="n">now_ms</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_ms</span><span class="p">)</span>
        <span class="n">prev_window_start</span> <span class="o">=</span> <span class="n">curr_window_start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_ms</span>
        <span class="n">curr_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">curr_window_start</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">prev_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">prev_window_start</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">curr_key</span><span class="p">,</span>
            <span class="n">prev_key</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">curr_window_start</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_ms</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">retry_after</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="fastapicap.SlidingWindowRateLimiter.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Applies the approximated sliding window rate limiting logic to the incoming request.</p>
<p>This method is the core of the rate limiter. It interacts with Redis to
increment counters for the current and previous window segments and
checks if the estimated count within the sliding window exceeds the limit.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request</code>
            </td>
            <td>
                  <code><span title="fastapi.Request">Request</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The incoming FastAPI request object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>response</code>
            </td>
            <td>
                  <code><span title="fastapi.Response">Response</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The FastAPI response object. This can be
modified by the <code>on_limit</code> handler if needed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="HTTPException">HTTPException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>By default, if the rate limit is exceeded,
<code>BaseLimiter._default_on_limit</code> will raise an <code>HTTPException</code>
with status code 429. Custom <code>on_limit</code> functions may raise
other exceptions or handle the response differently.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>fastapicap/strategy/sliding_window.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies the approximated sliding window rate limiting logic to the incoming request.</span>

<span class="sd">    This method is the core of the rate limiter. It interacts with Redis to</span>
<span class="sd">    increment counters for the current and previous window segments and</span>
<span class="sd">    checks if the estimated count within the sliding window exceeds the limit.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming FastAPI request object.</span>
<span class="sd">        response (Response): The FastAPI response object. This can be</span>
<span class="sd">            modified by the `on_limit` handler if needed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">            `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">            with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">            other exceptions or handle the response differently.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">now_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">curr_window_start</span> <span class="o">=</span> <span class="n">now_ms</span> <span class="o">-</span> <span class="p">(</span><span class="n">now_ms</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_ms</span><span class="p">)</span>
    <span class="n">prev_window_start</span> <span class="o">=</span> <span class="n">curr_window_start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_ms</span>
    <span class="n">curr_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">curr_window_start</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">prev_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">prev_window_start</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="n">curr_key</span><span class="p">,</span>
        <span class="n">prev_key</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">curr_window_start</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_ms</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">retry_after</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="fastapicap.TokenBucketRateLimiter" class="doc doc-heading">
            <code>fastapicap.TokenBucketRateLimiter</code>


</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="fastapicap.base_limiter.BaseLimiter">BaseLimiter</span></code></p>


        <p>Implements the Token Bucket rate limiting algorithm.</p>
<p>The Token Bucket algorithm works like a bucket that tokens are continuously
added to at a fixed <code>refill_rate</code>. Each request consumes one token.
If a request arrives and there are tokens available in the bucket,
the request is processed, and a token is removed. If the bucket is empty,
the request is denied (or queued). The <code>capacity</code> defines the maximum
number of tokens the bucket can hold, allowing for bursts of traffic
up to that capacity. This algorithm is excellent for controlling the
average rate of requests while permitting bursts.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>capacity</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of tokens the bucket can hold.
This determines the maximum burst size allowed. Must be a
positive integer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokens_per_second</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The rate at which tokens are added to the
bucket, in tokens per second. If combined with other <code>tokens_per_*</code>
arguments, they are summed to determine the total <code>refill_rate</code>.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokens_per_minute</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The token refill rate in tokens per minute.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokens_per_hour</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The token refill rate in tokens per hour.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokens_per_day</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The token refill rate in tokens per day.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_func</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>], <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An asynchronous or
synchronous function to extract a unique key from the request.
Defaults to client IP and path. The function should accept
a <code>fastapi.Request</code> object and return a <code>str</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>on_limit</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>, <span title="fastapi.Response">Response</span>, <span title="int">int</span>], None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An
asynchronous or synchronous function called when the rate limit is exceeded.
Defaults to raising HTTP 429. The function should accept a
<code>fastapi.Request</code>, <code>fastapi.Response</code>, and an <code>int</code> (retry_after seconds),
and should not return a value.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Redis key prefix for all limiter keys.
Defaults to "cap".</p>
              </div>
            </td>
            <td>
                  <code>&#39;cap&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.TokenBucketRateLimiter.capacity">capacity</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The configured maximum bucket capacity.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.TokenBucketRateLimiter.refill_rate">refill_rate</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The total calculated token refill rate in
tokens per millisecond.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.TokenBucketRateLimiter.lua_script">lua_script</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Lua script used for token bucket logic in Redis.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.TokenBucketRateLimiter._instance_id">_instance_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A unique identifier for this limiter instance, used
to create distinct Redis keys for isolation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the <code>capacity</code> is not positive, or if the total
calculated <code>refill_rate</code> is not positive. This ensures a valid
configuration for the token bucket.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>fastapicap/strategy/token_bucket.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TokenBucketRateLimiter</span><span class="p">(</span><span class="n">BaseLimiter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements the Token Bucket rate limiting algorithm.</span>

<span class="sd">    The Token Bucket algorithm works like a bucket that tokens are continuously</span>
<span class="sd">    added to at a fixed `refill_rate`. Each request consumes one token.</span>
<span class="sd">    If a request arrives and there are tokens available in the bucket,</span>
<span class="sd">    the request is processed, and a token is removed. If the bucket is empty,</span>
<span class="sd">    the request is denied (or queued). The `capacity` defines the maximum</span>
<span class="sd">    number of tokens the bucket can hold, allowing for bursts of traffic</span>
<span class="sd">    up to that capacity. This algorithm is excellent for controlling the</span>
<span class="sd">    average rate of requests while permitting bursts.</span>

<span class="sd">    Args:</span>
<span class="sd">        capacity (int): The maximum number of tokens the bucket can hold.</span>
<span class="sd">            This determines the maximum burst size allowed. Must be a</span>
<span class="sd">            positive integer.</span>
<span class="sd">        tokens_per_second (float): The rate at which tokens are added to the</span>
<span class="sd">            bucket, in tokens per second. If combined with other `tokens_per_*`</span>
<span class="sd">            arguments, they are summed to determine the total `refill_rate`.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        tokens_per_minute (float): The token refill rate in tokens per minute.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        tokens_per_hour (float): The token refill rate in tokens per hour.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        tokens_per_day (float): The token refill rate in tokens per day.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        key_func (Optional[Callable[[Request], str]]): An asynchronous or</span>
<span class="sd">            synchronous function to extract a unique key from the request.</span>
<span class="sd">            Defaults to client IP and path. The function should accept</span>
<span class="sd">            a `fastapi.Request` object and return a `str`.</span>
<span class="sd">        on_limit (Optional[Callable[[Request, Response, int], None]]): An</span>
<span class="sd">            asynchronous or synchronous function called when the rate limit is exceeded.</span>
<span class="sd">            Defaults to raising HTTP 429. The function should accept a</span>
<span class="sd">            `fastapi.Request`, `fastapi.Response`, and an `int` (retry_after seconds),</span>
<span class="sd">            and should not return a value.</span>
<span class="sd">        prefix (str): Redis key prefix for all limiter keys.</span>
<span class="sd">            Defaults to &quot;cap&quot;.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        capacity (int): The configured maximum bucket capacity.</span>
<span class="sd">        refill_rate (float): The total calculated token refill rate in</span>
<span class="sd">            tokens per millisecond.</span>
<span class="sd">        lua_script (str): The Lua script used for token bucket logic in Redis.</span>
<span class="sd">        _instance_id (str): A unique identifier for this limiter instance, used</span>
<span class="sd">            to create distinct Redis keys for isolation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the `capacity` is not positive, or if the total</span>
<span class="sd">            calculated `refill_rate` is not positive. This ensures a valid</span>
<span class="sd">            configuration for the token bucket.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">tokens_per_second</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">tokens_per_minute</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">tokens_per_hour</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">tokens_per_day</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">key_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cap&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">key_func</span><span class="o">=</span><span class="n">key_func</span><span class="p">,</span> <span class="n">on_limit</span><span class="o">=</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">capacity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Capacity must be a positive integer.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="n">total_tokens</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tokens_per_second</span>
            <span class="o">+</span> <span class="n">tokens_per_minute</span> <span class="o">/</span> <span class="mi">60</span>
            <span class="o">+</span> <span class="n">tokens_per_hour</span> <span class="o">/</span> <span class="mi">3600</span>
            <span class="o">+</span> <span class="n">tokens_per_day</span> <span class="o">/</span> <span class="mi">86400</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span> <span class="o">=</span> <span class="n">total_tokens</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span> <span class="o">=</span> <span class="n">TOKEN_BUCKET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;token_bucket_limiter_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Refill rate must be positive.&quot;</span>
                <span class="s2">&quot;Check your tokens_per_second/minute/hour/day arguments.&quot;</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies the Token Bucket rate limiting logic to the incoming request.</span>

<span class="sd">        This method is the core of the rate limiter. It interacts with Redis to simulate</span>
<span class="sd">        token consumption and bucket refill, determining if the request is allowed.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (Request): The incoming FastAPI request object.</span>
<span class="sd">            response (Response): The FastAPI response object. This can be</span>
<span class="sd">                modified by the `on_limit` handler if needed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">                `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">                with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">                other exceptions or handle the response differently.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">full_key</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">retry_after</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">//</span> <span class="mi">1000</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="fastapicap.TokenBucketRateLimiter.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Applies the Token Bucket rate limiting logic to the incoming request.</p>
<p>This method is the core of the rate limiter. It interacts with Redis to simulate
token consumption and bucket refill, determining if the request is allowed.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request</code>
            </td>
            <td>
                  <code><span title="fastapi.Request">Request</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The incoming FastAPI request object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>response</code>
            </td>
            <td>
                  <code><span title="fastapi.Response">Response</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The FastAPI response object. This can be
modified by the <code>on_limit</code> handler if needed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="HTTPException">HTTPException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>By default, if the rate limit is exceeded,
<code>BaseLimiter._default_on_limit</code> will raise an <code>HTTPException</code>
with status code 429. Custom <code>on_limit</code> functions may raise
other exceptions or handle the response differently.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>fastapicap/strategy/token_bucket.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies the Token Bucket rate limiting logic to the incoming request.</span>

<span class="sd">    This method is the core of the rate limiter. It interacts with Redis to simulate</span>
<span class="sd">    token consumption and bucket refill, determining if the request is allowed.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming FastAPI request object.</span>
<span class="sd">        response (Response): The FastAPI response object. This can be</span>
<span class="sd">            modified by the `on_limit` handler if needed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">            `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">            with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">            other exceptions or handle the response differently.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="n">full_key</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">retry_after</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">//</span> <span class="mi">1000</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="fastapicap.LeakyBucketRateLimiter" class="doc doc-heading">
            <code>fastapicap.LeakyBucketRateLimiter</code>


</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="fastapicap.base_limiter.BaseLimiter">BaseLimiter</span></code></p>


        <p>Implements the Leaky Bucket rate limiting algorithm.</p>
<p>The Leaky Bucket algorithm models traffic flow like water in a bucket.
Requests are "drops" added to the bucket. If the bucket overflows (exceeds capacity),
new requests are rejected. "Water" (requests) leaks out of the bucket at a
constant rate, making space for new requests. This algorithm is known for
producing a smooth, constant output rate of requests, which helps in
preventing bursts from overwhelming downstream services.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>capacity</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum capacity of the bucket. This represents
the maximum number of requests that can be held in the bucket
before new requests are rejected. Must be a positive integer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>leaks_per_second</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The rate at which requests "leak" (are processed)
from the bucket, in requests per second. If combined with other
<code>leaks_per_*</code> arguments, they are summed. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>leaks_per_minute</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The leak rate in requests per minute.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>leaks_per_hour</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The leak rate in requests per hour.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>leaks_per_day</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The leak rate in requests per day.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_func</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>], <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An asynchronous or
synchronous function to extract a unique key from the request.
Defaults to client IP and path. The function should accept
a <code>fastapi.Request</code> object and return a <code>str</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>on_limit</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>, <span title="fastapi.Response">Response</span>, <span title="int">int</span>], None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An
asynchronous or synchronous function called when the rate limit is exceeded.
Defaults to raising HTTP 429. The function should accept a
<code>fastapi.Request</code>, <code>fastapi.Response</code>, and an <code>int</code> (retry_after seconds),
and should not return a value.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Redis key prefix for all limiter keys.
Defaults to "cap".</p>
              </div>
            </td>
            <td>
                  <code>&#39;cap&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.LeakyBucketRateLimiter.capacity">capacity</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The configured maximum bucket capacity.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.LeakyBucketRateLimiter.leak_rate">leak_rate</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The total calculated leak rate in requests per millisecond.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.LeakyBucketRateLimiter.lua_script">lua_script</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Lua script used for leaky bucket logic in Redis.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.LeakyBucketRateLimiter._instance_id">_instance_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A unique identifier for this limiter instance, used
to create distinct Redis keys for isolation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the <code>capacity</code> is not positive, or if the total
calculated <code>leak_rate</code> is not positive. This ensures a valid
configuration for the leaky bucket.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>fastapicap/strategy/leaky_bucket.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LeakyBucketRateLimiter</span><span class="p">(</span><span class="n">BaseLimiter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements the Leaky Bucket rate limiting algorithm.</span>

<span class="sd">    The Leaky Bucket algorithm models traffic flow like water in a bucket.</span>
<span class="sd">    Requests are &quot;drops&quot; added to the bucket. If the bucket overflows (exceeds capacity),</span>
<span class="sd">    new requests are rejected. &quot;Water&quot; (requests) leaks out of the bucket at a</span>
<span class="sd">    constant rate, making space for new requests. This algorithm is known for</span>
<span class="sd">    producing a smooth, constant output rate of requests, which helps in</span>
<span class="sd">    preventing bursts from overwhelming downstream services.</span>

<span class="sd">    Args:</span>
<span class="sd">        capacity (int): The maximum capacity of the bucket. This represents</span>
<span class="sd">            the maximum number of requests that can be held in the bucket</span>
<span class="sd">            before new requests are rejected. Must be a positive integer.</span>
<span class="sd">        leaks_per_second (float): The rate at which requests &quot;leak&quot; (are processed)</span>
<span class="sd">            from the bucket, in requests per second. If combined with other</span>
<span class="sd">            `leaks_per_*` arguments, they are summed. Defaults to 0.</span>
<span class="sd">        leaks_per_minute (float): The leak rate in requests per minute.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        leaks_per_hour (float): The leak rate in requests per hour.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        leaks_per_day (float): The leak rate in requests per day.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        key_func (Optional[Callable[[Request], str]]): An asynchronous or</span>
<span class="sd">            synchronous function to extract a unique key from the request.</span>
<span class="sd">            Defaults to client IP and path. The function should accept</span>
<span class="sd">            a `fastapi.Request` object and return a `str`.</span>
<span class="sd">        on_limit (Optional[Callable[[Request, Response, int], None]]): An</span>
<span class="sd">            asynchronous or synchronous function called when the rate limit is exceeded.</span>
<span class="sd">            Defaults to raising HTTP 429. The function should accept a</span>
<span class="sd">            `fastapi.Request`, `fastapi.Response`, and an `int` (retry_after seconds),</span>
<span class="sd">            and should not return a value.</span>
<span class="sd">        prefix (str): Redis key prefix for all limiter keys.</span>
<span class="sd">            Defaults to &quot;cap&quot;.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        capacity (int): The configured maximum bucket capacity.</span>
<span class="sd">        leak_rate (float): The total calculated leak rate in requests per millisecond.</span>
<span class="sd">        lua_script (str): The Lua script used for leaky bucket logic in Redis.</span>
<span class="sd">        _instance_id (str): A unique identifier for this limiter instance, used</span>
<span class="sd">            to create distinct Redis keys for isolation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the `capacity` is not positive, or if the total</span>
<span class="sd">            calculated `leak_rate` is not positive. This ensures a valid</span>
<span class="sd">            configuration for the leaky bucket.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">leaks_per_second</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">leaks_per_minute</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">leaks_per_hour</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">leaks_per_day</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">key_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cap&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">key_func</span><span class="o">=</span><span class="n">key_func</span><span class="p">,</span> <span class="n">on_limit</span><span class="o">=</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="k">if</span> <span class="n">capacity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Capacity must be a positive integer.&quot;</span><span class="p">)</span>
        <span class="n">total_leaks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">leaks_per_second</span>
            <span class="o">+</span> <span class="n">leaks_per_minute</span> <span class="o">/</span> <span class="mi">60</span>
            <span class="o">+</span> <span class="n">leaks_per_hour</span> <span class="o">/</span> <span class="mi">3600</span>
            <span class="o">+</span> <span class="n">leaks_per_day</span> <span class="o">/</span> <span class="mi">86400</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leak_rate</span> <span class="o">=</span> <span class="n">total_leaks</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span> <span class="o">=</span> <span class="n">LEAKY_BUCKET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;leaky_bucket_limiter_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies the leaky bucket rate limiting logic to the incoming request.</span>

<span class="sd">        This method is the core of the rate limiter. It interacts with Redis to simulate</span>
<span class="sd">        adding a &quot;drop&quot; to the bucket and checks if it overflows.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (Request): The incoming FastAPI request object.</span>
<span class="sd">            response (Response): The FastAPI response object. This can be</span>
<span class="sd">                modified by the `on_limit` handler if needed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">                `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">                with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">                other exceptions or handle the response differently.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">full_key</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leak_rate</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">retry_after</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">+</span> <span class="mi">999</span><span class="p">)</span> <span class="o">//</span> <span class="mi">1000</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="fastapicap.LeakyBucketRateLimiter.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Applies the leaky bucket rate limiting logic to the incoming request.</p>
<p>This method is the core of the rate limiter. It interacts with Redis to simulate
adding a "drop" to the bucket and checks if it overflows.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request</code>
            </td>
            <td>
                  <code><span title="fastapi.Request">Request</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The incoming FastAPI request object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>response</code>
            </td>
            <td>
                  <code><span title="fastapi.Response">Response</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The FastAPI response object. This can be
modified by the <code>on_limit</code> handler if needed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="HTTPException">HTTPException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>By default, if the rate limit is exceeded,
<code>BaseLimiter._default_on_limit</code> will raise an <code>HTTPException</code>
with status code 429. Custom <code>on_limit</code> functions may raise
other exceptions or handle the response differently.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>fastapicap/strategy/leaky_bucket.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies the leaky bucket rate limiting logic to the incoming request.</span>

<span class="sd">    This method is the core of the rate limiter. It interacts with Redis to simulate</span>
<span class="sd">    adding a &quot;drop&quot; to the bucket and checks if it overflows.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming FastAPI request object.</span>
<span class="sd">        response (Response): The FastAPI response object. This can be</span>
<span class="sd">            modified by the `on_limit` handler if needed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">            `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">            with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">            other exceptions or handle the response differently.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="n">full_key</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leak_rate</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">retry_after</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">+</span> <span class="mi">999</span><span class="p">)</span> <span class="o">//</span> <span class="mi">1000</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="fastapicap.GCRARateLimiter" class="doc doc-heading">
            <code>fastapicap.GCRARateLimiter</code>


</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="fastapicap.base_limiter.BaseLimiter">BaseLimiter</span></code></p>


        <p>Implements the Generic Cell Rate Algorithm (GCRA) for rate limiting.</p>
<p>GCRA is a popular algorithm that controls the rate of events by tracking
the "Theoretical Arrival Time" (TAT) of the next allowed event. It's often
used for API rate limiting as it provides a smooth, burstable rate.</p>
<p>This limiter allows for a burst of requests up to <code>burst</code> capacity,
and then enforces a steady rate defined by <code>tokens_per_second</code>,
<code>tokens_per_minute</code>, <code>tokens_per_hour</code>, or <code>tokens_per_day</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>burst</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of additional requests that can be
served instantly (i.e., the "burst" capacity beyond the steady rate).
This defines how many requests can be handled without delay if
the system has been idle.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokens_per_second</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The steady rate of tokens allowed per second.
If combined with other <code>tokens_per_*</code> arguments, they are summed.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokens_per_minute</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The steady rate of tokens allowed per minute.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokens_per_hour</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The steady rate of tokens allowed per hour.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokens_per_day</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The steady rate of tokens allowed per day.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_func</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>], <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An asynchronous function
to extract a unique key from the request. This key is used to
identify the subject being rate-limited (e.g., client IP, user ID).
If <code>None</code>, <code>BaseLimiter._default_key_func</code> (client IP + path) is used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>on_limit</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>, <span title="fastapi.Response">Response</span>, <span title="int">int</span>], None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An
asynchronous function called when the rate limit is exceeded.
It receives the <code>request</code>, <code>response</code> object, and the <code>retry_after</code>
value in seconds. If <code>None</code>, <code>BaseLimiter._default_on_limit</code>
(which raises an <code>HTTPException 429</code>) is used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string prefix for all Redis keys used by this limiter.
Defaults to "cap".</p>
              </div>
            </td>
            <td>
                  <code>&#39;cap&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.GCRARateLimiter.burst">burst</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The configured burst capacity.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.GCRARateLimiter.tokens_per_second">tokens_per_second</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The total calculated steady rate in tokens per second.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.GCRARateLimiter.period">period</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The calculated time period (in milliseconds) between allowed tokens.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.GCRARateLimiter.lua_script">lua_script</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Lua script used for GCRA logic in Redis.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.GCRARateLimiter._instance_id">_instance_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A unique identifier for this limiter instance, used
to create distinct Redis keys.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the total calculated <code>tokens_per_second</code> is not positive.
This ensures that a meaningful rate limit is defined.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The <code>GCRA_LUA</code> script handles the core rate-limiting logic in Redis,
ensuring atomic operations. The <code>retry_after</code> value returned by the
Lua script (if a limit is hit) indicates the number of milliseconds
until the next request would be allowed.</p>
</details>






              <details class="quote">
                <summary>Source code in <code>fastapicap/strategy/gcra.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GCRARateLimiter</span><span class="p">(</span><span class="n">BaseLimiter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements the Generic Cell Rate Algorithm (GCRA) for rate limiting.</span>

<span class="sd">    GCRA is a popular algorithm that controls the rate of events by tracking</span>
<span class="sd">    the &quot;Theoretical Arrival Time&quot; (TAT) of the next allowed event. It&#39;s often</span>
<span class="sd">    used for API rate limiting as it provides a smooth, burstable rate.</span>

<span class="sd">    This limiter allows for a burst of requests up to `burst` capacity,</span>
<span class="sd">    and then enforces a steady rate defined by `tokens_per_second`,</span>
<span class="sd">    `tokens_per_minute`, `tokens_per_hour`, or `tokens_per_day`.</span>

<span class="sd">    Args:</span>
<span class="sd">        burst (int): The maximum number of additional requests that can be</span>
<span class="sd">            served instantly (i.e., the &quot;burst&quot; capacity beyond the steady rate).</span>
<span class="sd">            This defines how many requests can be handled without delay if</span>
<span class="sd">            the system has been idle.</span>
<span class="sd">        tokens_per_second (float): The steady rate of tokens allowed per second.</span>
<span class="sd">            If combined with other `tokens_per_*` arguments, they are summed.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        tokens_per_minute (float): The steady rate of tokens allowed per minute.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        tokens_per_hour (float): The steady rate of tokens allowed per hour.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        tokens_per_day (float): The steady rate of tokens allowed per day.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        key_func (Optional[Callable[[Request], str]]): An asynchronous function</span>
<span class="sd">            to extract a unique key from the request. This key is used to</span>
<span class="sd">            identify the subject being rate-limited (e.g., client IP, user ID).</span>
<span class="sd">            If `None`, `BaseLimiter._default_key_func` (client IP + path) is used.</span>
<span class="sd">        on_limit (Optional[Callable[[Request, Response, int], None]]): An</span>
<span class="sd">            asynchronous function called when the rate limit is exceeded.</span>
<span class="sd">            It receives the `request`, `response` object, and the `retry_after`</span>
<span class="sd">            value in seconds. If `None`, `BaseLimiter._default_on_limit`</span>
<span class="sd">            (which raises an `HTTPException 429`) is used.</span>
<span class="sd">        prefix (str): A string prefix for all Redis keys used by this limiter.</span>
<span class="sd">            Defaults to &quot;cap&quot;.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        burst (int): The configured burst capacity.</span>
<span class="sd">        tokens_per_second (float): The total calculated steady rate in tokens per second.</span>
<span class="sd">        period (float): The calculated time period (in milliseconds) between allowed tokens.</span>
<span class="sd">        lua_script (str): The Lua script used for GCRA logic in Redis.</span>
<span class="sd">        _instance_id (str): A unique identifier for this limiter instance, used</span>
<span class="sd">            to create distinct Redis keys.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the total calculated `tokens_per_second` is not positive.</span>
<span class="sd">            This ensures that a meaningful rate limit is defined.</span>

<span class="sd">    Note:</span>
<span class="sd">        The `GCRA_LUA` script handles the core rate-limiting logic in Redis,</span>
<span class="sd">        ensuring atomic operations. The `retry_after` value returned by the</span>
<span class="sd">        Lua script (if a limit is hit) indicates the number of milliseconds</span>
<span class="sd">        until the next request would be allowed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">burst</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">tokens_per_second</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">tokens_per_minute</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">tokens_per_hour</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">tokens_per_day</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">key_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cap&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">key_func</span><span class="o">=</span><span class="n">key_func</span><span class="p">,</span> <span class="n">on_limit</span><span class="o">=</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">burst</span> <span class="o">=</span> <span class="n">burst</span>
        <span class="n">total_tokens_per_second</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tokens_per_second</span>
            <span class="o">+</span> <span class="n">tokens_per_minute</span> <span class="o">/</span> <span class="mi">60</span>
            <span class="o">+</span> <span class="n">tokens_per_hour</span> <span class="o">/</span> <span class="mi">3600</span>
            <span class="o">+</span> <span class="n">tokens_per_day</span> <span class="o">/</span> <span class="mi">86400</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">total_tokens_per_second</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;At least one of tokens_per_second, tokens_per_minute, &quot;</span>
                <span class="s2">&quot;tokens_per_hour, or tokens_per_day must be positive.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tokens_per_second</span> <span class="o">=</span> <span class="n">total_tokens_per_second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens_per_second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span> <span class="o">=</span> <span class="n">GCRA_LUA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;gcra_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the GCRA rate-limiting logic for the incoming request.</span>

<span class="sd">        This method is designed to be used as a FastAPI dependency or decorator.</span>
<span class="sd">        It interacts with Redis to check if the request is allowed based on</span>
<span class="sd">        the configured GCRA parameters. If the limit is exceeded, it calls</span>
<span class="sd">        the `on_limit` handler.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (Request): The incoming FastAPI request object.</span>
<span class="sd">            response (Response): The FastAPI response object. This can be</span>
<span class="sd">                modified by the `on_limit` handler if needed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">                `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">                with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">                other exceptions or handle the response differently.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">full_key</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">burst</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokens_per_second</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span>  <span class="c1"># tokens/ms</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">retry_after</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="fastapicap.GCRARateLimiter.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Executes the GCRA rate-limiting logic for the incoming request.</p>
<p>This method is designed to be used as a FastAPI dependency or decorator.
It interacts with Redis to check if the request is allowed based on
the configured GCRA parameters. If the limit is exceeded, it calls
the <code>on_limit</code> handler.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request</code>
            </td>
            <td>
                  <code><span title="fastapi.Request">Request</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The incoming FastAPI request object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>response</code>
            </td>
            <td>
                  <code><span title="fastapi.Response">Response</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The FastAPI response object. This can be
modified by the <code>on_limit</code> handler if needed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="HTTPException">HTTPException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>By default, if the rate limit is exceeded,
<code>BaseLimiter._default_on_limit</code> will raise an <code>HTTPException</code>
with status code 429. Custom <code>on_limit</code> functions may raise
other exceptions or handle the response differently.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>fastapicap/strategy/gcra.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the GCRA rate-limiting logic for the incoming request.</span>

<span class="sd">    This method is designed to be used as a FastAPI dependency or decorator.</span>
<span class="sd">    It interacts with Redis to check if the request is allowed based on</span>
<span class="sd">    the configured GCRA parameters. If the limit is exceeded, it calls</span>
<span class="sd">    the `on_limit` handler.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming FastAPI request object.</span>
<span class="sd">        response (Response): The FastAPI response object. This can be</span>
<span class="sd">            modified by the `on_limit` handler if needed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">            `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">            with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">            other exceptions or handle the response differently.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="n">full_key</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">burst</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokens_per_second</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span>  <span class="c1"># tokens/ms</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">retry_after</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="fastapicap.SlidingWindowLogRateLimiter" class="doc doc-heading">
            <code>fastapicap.SlidingWindowLogRateLimiter</code>


</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="fastapicap.base_limiter.BaseLimiter">BaseLimiter</span></code></p>


        <p>Implements a <strong>Sliding Window (Log-based)</strong> rate limiting algorithm.</p>
<p>This is the most accurate form of the sliding window algorithm. It works by
storing a timestamp for every request made by a client within a Redis sorted set.
When a new request comes in, the algorithm first removes all timestamps that
fall outside the current sliding window. Then, it counts the number of remaining
timestamps within the window. If this count is below the <code>limit</code>, the request
is allowed, and its timestamp is added to the set. This method ensures
precise rate limiting as the window truly "slides" over time.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of requests allowed within the defined
sliding window. Must be a positive integer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>window_seconds</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of seconds defining the size of the
sliding window. Can be combined with minutes, hours, or days.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>window_minutes</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of minutes defining the window size.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>window_hours</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of hours defining the window size.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>window_days</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of days defining the window size.
Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_func</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>], <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An asynchronous or
synchronous function to extract a unique key from the request.
Defaults to client IP and path. The function should accept
a <code>fastapi.Request</code> object and return a <code>str</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>on_limit</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Callable">Callable</span>[[<span title="fastapi.Request">Request</span>, <span title="fastapi.Response">Response</span>, <span title="int">int</span>], None]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An
asynchronous or synchronous function called when the rate limit is exceeded.
Defaults to raising HTTP 429. The function should accept a
<code>fastapi.Request</code>, <code>fastapi.Response</code>, and an <code>int</code> (retry_after seconds),
and should not return a value.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Redis key prefix for all limiter keys.
Defaults to "cap".</p>
              </div>
            </td>
            <td>
                  <code>&#39;cap&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.SlidingWindowLogRateLimiter.limit">limit</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum requests allowed within the sliding window.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.SlidingWindowLogRateLimiter.window_seconds">window_seconds</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The total calculated window size in seconds.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.SlidingWindowLogRateLimiter.lua_script">lua_script</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Lua script used for the log-based sliding window
logic in Redis.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fastapicap.SlidingWindowLogRateLimiter._instance_id">_instance_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A unique identifier for this limiter instance, used
to create distinct Redis keys for isolation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the <code>limit</code> is not positive or if the calculated
<code>window_seconds</code> is not positive (i.e., all time units are zero).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This implementation uses Redis sorted sets (<code>ZADD</code>, <code>ZREMRANGEBYSCORE</code>, <code>ZCARD</code>)
to store and manage request timestamps, ensuring atomic operations
for accurate rate limiting.</p>
</details>






              <details class="quote">
                <summary>Source code in <code>fastapicap/strategy/sliding_window_log.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SlidingWindowLogRateLimiter</span><span class="p">(</span><span class="n">BaseLimiter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements a **Sliding Window (Log-based)** rate limiting algorithm.</span>

<span class="sd">    This is the most accurate form of the sliding window algorithm. It works by</span>
<span class="sd">    storing a timestamp for every request made by a client within a Redis sorted set.</span>
<span class="sd">    When a new request comes in, the algorithm first removes all timestamps that</span>
<span class="sd">    fall outside the current sliding window. Then, it counts the number of remaining</span>
<span class="sd">    timestamps within the window. If this count is below the `limit`, the request</span>
<span class="sd">    is allowed, and its timestamp is added to the set. This method ensures</span>
<span class="sd">    precise rate limiting as the window truly &quot;slides&quot; over time.</span>

<span class="sd">    Args:</span>
<span class="sd">        limit (int): The maximum number of requests allowed within the defined</span>
<span class="sd">            sliding window. Must be a positive integer.</span>
<span class="sd">        window_seconds (int): The number of seconds defining the size of the</span>
<span class="sd">            sliding window. Can be combined with minutes, hours, or days.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        window_minutes (int): The number of minutes defining the window size.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        window_hours (int): The number of hours defining the window size.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        window_days (int): The number of days defining the window size.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        key_func (Optional[Callable[[Request], str]]): An asynchronous or</span>
<span class="sd">            synchronous function to extract a unique key from the request.</span>
<span class="sd">            Defaults to client IP and path. The function should accept</span>
<span class="sd">            a `fastapi.Request` object and return a `str`.</span>
<span class="sd">        on_limit (Optional[Callable[[Request, Response, int], None]]): An</span>
<span class="sd">            asynchronous or synchronous function called when the rate limit is exceeded.</span>
<span class="sd">            Defaults to raising HTTP 429. The function should accept a</span>
<span class="sd">            `fastapi.Request`, `fastapi.Response`, and an `int` (retry_after seconds),</span>
<span class="sd">            and should not return a value.</span>
<span class="sd">        prefix (str): Redis key prefix for all limiter keys.</span>
<span class="sd">            Defaults to &quot;cap&quot;.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        limit (int): The maximum requests allowed within the sliding window.</span>
<span class="sd">        window_seconds (int): The total calculated window size in seconds.</span>
<span class="sd">        lua_script (str): The Lua script used for the log-based sliding window</span>
<span class="sd">            logic in Redis.</span>
<span class="sd">        _instance_id (str): A unique identifier for this limiter instance, used</span>
<span class="sd">            to create distinct Redis keys for isolation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the `limit` is not positive or if the calculated</span>
<span class="sd">            `window_seconds` is not positive (i.e., all time units are zero).</span>

<span class="sd">    Note:</span>
<span class="sd">        This implementation uses Redis sorted sets (`ZADD`, `ZREMRANGEBYSCORE`, `ZCARD`)</span>
<span class="sd">        to store and manage request timestamps, ensuring atomic operations</span>
<span class="sd">        for accurate rate limiting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">window_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">window_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">window_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">window_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">key_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cap&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">key_func</span><span class="o">=</span><span class="n">key_func</span><span class="p">,</span> <span class="n">on_limit</span><span class="o">=</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Limit must be a positive integer.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_seconds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">window_seconds</span>
            <span class="o">+</span> <span class="n">window_minutes</span> <span class="o">*</span> <span class="mi">60</span>
            <span class="o">+</span> <span class="n">window_hours</span> <span class="o">*</span> <span class="mi">3600</span>
            <span class="o">+</span> <span class="n">window_days</span> <span class="o">*</span> <span class="mi">86400</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_seconds</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Window must be positive (set seconds, minutes, hours, or days)&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span> <span class="o">=</span> <span class="n">SLIDING_LOG_LUA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sliding_log_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies the log-based sliding window rate limiting logic to the incoming request.</span>

<span class="sd">        This method is the core of the rate limiter. It interacts with Redis to</span>
<span class="sd">        manage request timestamps within a sorted set and checks if the total</span>
<span class="sd">        count within the current sliding window exceeds the configured limit.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (Request): The incoming FastAPI request object.</span>
<span class="sd">            response (Response): The FastAPI response object. This can be</span>
<span class="sd">                modified by the `on_limit` handler if needed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">                `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">                with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">                other exceptions or handle the response differently.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">window_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_seconds</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">full_key</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">window_ms</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">retry_after</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">allowed</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="fastapicap.SlidingWindowLogRateLimiter.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Applies the log-based sliding window rate limiting logic to the incoming request.</p>
<p>This method is the core of the rate limiter. It interacts with Redis to
manage request timestamps within a sorted set and checks if the total
count within the current sliding window exceeds the configured limit.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request</code>
            </td>
            <td>
                  <code><span title="fastapi.Request">Request</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The incoming FastAPI request object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>response</code>
            </td>
            <td>
                  <code><span title="fastapi.Response">Response</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The FastAPI response object. This can be
modified by the <code>on_limit</code> handler if needed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="HTTPException">HTTPException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>By default, if the rate limit is exceeded,
<code>BaseLimiter._default_on_limit</code> will raise an <code>HTTPException</code>
with status code 429. Custom <code>on_limit</code> functions may raise
other exceptions or handle the response differently.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>fastapicap/strategy/sliding_window_log.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies the log-based sliding window rate limiting logic to the incoming request.</span>

<span class="sd">    This method is the core of the rate limiter. It interacts with Redis to</span>
<span class="sd">    manage request timestamps within a sorted set and checks if the total</span>
<span class="sd">    count within the current sliding window exceeds the configured limit.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming FastAPI request object.</span>
<span class="sd">        response (Response): The FastAPI response object. This can be</span>
<span class="sd">            modified by the `on_limit` handler if needed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: By default, if the rate limit is exceeded,</span>
<span class="sd">            `BaseLimiter._default_on_limit` will raise an `HTTPException`</span>
<span class="sd">            with status code 429. Custom `on_limit` functions may raise</span>
<span class="sd">            other exceptions or handle the response differently.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_redis</span><span class="p">()</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_lua_sha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lua_script</span><span class="p">)</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_func</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">window_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_seconds</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">evalsha</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua_sha</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="n">full_key</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">window_ms</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">retry_after</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">allowed</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_limit</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retry_after</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/devbijay/FastAPI-Cap" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.sections", "navigation.expand", "toc.integrate", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate", "content.tabs.link", "content.action.edit", "content.action.view", "content.footnote.tooltips"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>